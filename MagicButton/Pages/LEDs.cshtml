@page
@model MagicButton.Pages.LEDsModel
@{
}
<h1><i class="bi bi-lightbulb-fill"></i> LED Test</h1>
<hr/>
@Html.AntiForgeryToken()
<div class="container py-4">
    <h5 class="mb-3">LED Test (press & hold)</h5>
    <p>or hold Shift+R/G/A</p>
    <!-- Example: Green on GPIO pin 17 -->
    <button class="btn btn-success btn-lg me-2"
            data-pin="17"
            hx-post="/gpio/on"
            hx-vals='js:{"pin": this.dataset.pin}'
            hx-trigger="mousedown, touchstart"
            hx-target="this"
            hx-swap="none"
            hx-on:mouseup="htmx.ajax('POST','/gpio/off',{values:{pin:this.dataset.pin}})"
            hx-on:mouseleave="htmx.ajax('POST','/gpio/off',{values:{pin:this.dataset.pin}})"
            hx-on:touchend="htmx.ajax('POST','/gpio/off',{values:{pin:this.dataset.pin}})"
            title="Shift+G to toggle while held">
        Green (pin 17)
    </button>

    <!-- Amber on pin 22 -->
    <button class="btn btn-warning btn-lg me-2"
            data-pin="22"
            hx-post="/gpio/on"
            hx-vals='js:{"pin": this.dataset.pin}'
            hx-trigger="mousedown, touchstart"
            hx-target="this"
            hx-swap="none"
            hx-on:mouseup="htmx.ajax('POST','/gpio/off',{values:{pin:this.dataset.pin}})"
            hx-on:mouseleave="htmx.ajax('POST','/gpio/off',{values:{pin:this.dataset.pin}})"
            hx-on:touchend="htmx.ajax('POST','/gpio/off',{values:{pin:this.dataset.pin}})"
            title="Shift+A to toggle while held">
        Amber (pin 22)
    </button>

    <!-- Red on pin 27 -->
    <button class="btn btn-danger btn-lg"
            data-pin="27"
            hx-post="/gpio/on"
            hx-vals='js:{"pin": this.dataset.pin}'
            hx-trigger="mousedown, touchstart"
            hx-target="this"
            hx-swap="none"
            hx-on:mouseup="htmx.ajax('POST','/gpio/off',{values:{pin:this.dataset.pin}})"
            hx-on:mouseleave="htmx.ajax('POST','/gpio/off',{values:{pin:this.dataset.pin}})"
            hx-on:touchend="htmx.ajax('POST','/gpio/off',{values:{pin:this.dataset.pin}})"
            title="Shift+R to toggle while held">
        Red (pin 27)
    </button>
</div>


@section Scripts {

    <script>
        // Avoid spamming repeated keydown while held
        const activeKeys = new Set();

        const map = [
          { match: e => e.shiftKey && e.code === 'KeyG', pin: 17 },
          { match: e => e.shiftKey && e.code === 'KeyA', pin: 22 },
          { match: e => e.shiftKey && e.code === 'KeyR', pin: 27 },
        ];

        document.addEventListener('keydown', e => {
          const m = map.find(x => x.match(e));
          if (!m) return;

          const keySig = `${e.code}+shift`;
          if (activeKeys.has(keySig)) return; // already ON
          activeKeys.add(keySig);

          htmx.ajax('POST', '/gpio/on', { values: { pin: m.pin } });
        });

        document.addEventListener('keyup', e => {
          const m = map.find(x => x.match(e));
          if (!m) return;

          const keySig = `${e.code}+shift`;
          if (!activeKeys.has(keySig)) return;
          activeKeys.delete(keySig);

          htmx.ajax('POST', '/gpio/off', { values: { pin: m.pin } });
        });

        // Safety: turn everything off when page unloads
        window.addEventListener('blur', () => {
          activeKeys.forEach(sig => {
            const code = sig.split('+')[0];
            const m = map.find(x => `Key${x.pin === 17 ? 'G' : x.pin === 22 ? 'A' : 'R'}` === code);
            if (m) htmx.ajax('POST', '/gpio/off', { values: { pin: m.pin } });
          });
          activeKeys.clear();
        });
    </script>


}