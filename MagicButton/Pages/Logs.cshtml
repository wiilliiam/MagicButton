@page
@model MagicButton.Pages.LogsModel
@{
}
<h1><i class="bi bi-body-text"></i> Log File</h1>

<nav aria-label="breadcrumb">
    <ol class="breadcrumb bg-light p-2">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Log File</li>
    </ol>
</nav>

<div class="card shadow-sm">
    <div class="log-wrapper">
        <div id="log" class="log-container card-body"
             hx-get="/logs/tail?lines=500"
             hx-trigger="load, every 2s"
             hx-swap="innerHTML">
            <em>Loading logs…</em>
        </div>


        <div id="refresh-indicator" class="refresh-indicator">
            <div class="spinner-border spinner-border-sm text-light" role="status"></div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/htmx.org@1.9.12/dist/ext/class-tools.css">

@section scripts {

    <script>
        const log = document.getElementById('log');
        let autoScroll = true;
        let scrollTimeout;

        // 🧭 detect manual scrolling
        log.addEventListener('scroll', () => {
            const nearBottom = log.scrollHeight - log.scrollTop - log.clientHeight < 50;
            autoScroll = nearBottom;
        });

        // 🌀 show indicator + smooth scroll if allowed
        document.body.addEventListener('htmx:beforeRequest', (e) => {
            if (e.target.id === 'log') {
                document.getElementById('refresh-indicator')?.classList.add('active');
            }
        });

        document.body.addEventListener('htmx:afterSwap', (e) => {
            if (e.target.id === 'log') {
                document.getElementById('refresh-indicator')?.classList.remove('active');
                clearTimeout(scrollTimeout);
                if (autoScroll) {
                    // delay a wee bit to let HTMX render new content
                    scrollTimeout = setTimeout(() => {
                        log.scrollTo({ top: log.scrollHeight, behavior: 'smooth' });
                    }, 100);
                }
            }
        });


    </script>
}